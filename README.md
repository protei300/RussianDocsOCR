# Библиотека распознавания документов РФ

## О проекте
Данный проект реализует библиотеку детекции и распознавания текста на официальных документах РФ. 

Типы поддерживаемых документов:
1) Внутренний паспорт РФ. Версия 1997 года
2) Внутренний паспорт РФ. Версия 2011 года
3) Заграничный паспорт РФ. Версия 2003 года
4) Заграничный паспорт РФ - биометрический. Версия 2007 года
5) Водительские права РФ. Версия 2011 года
6) Водительские права РФ. Версия 2020 года
7) СНИЛС. Версия 1996 года

## Перечень направлений прикладного использования 
Данная библиотека может использоваться как основа или составная часть для программных продуктов организаций, работающих с большим количеством посетителей и оказывающих услуги, для оформления которых нужны перечисленные документы граждан РФ. Примеры направлений деятельности таких организаций:
- массовая поточная обработка и регистрация документов (МФЦ),
- медицинские учреждения,
- центры регистрации или аренды автотранспорта и автосалоны,
- риэлторские организации,
- производство вендинговых автоматов,
- торговля подакцизными товарами,
- таможни,
- правоохранительные органы и МВД,
- банки.


## Установка библиотеки

### Минимальные программно-аппаратные требования для библиотеки:
- HDD: 500мб свободного места
- CPU: x86 Intel core i3 gen 8 и выше или аналог от AMD
- GPU: Nvidia GTX 1060 и выше
- RAM: 6 GB
- OS: Windows 10 или Linux Ubuntu 22 lts
- Python: 3.9+.


#### Клонируем библиотеку:
`git clone https://github.com/protei300/RussianDocsOCR.git`

#### Устанавливаем зависимости:
```
cd RussianDocsOCR
pip install -r requirements.txt
```


## Описание структуры папок
Библиотека состоит из 4 основных папок:
1) `document_processing`. В папке хранятся основные модели, классы их запуска и класс Pipeline.
2) `samples`. В папке хранятся образцы документов каждого из типов (7 типов) с описанием текстовых значений полей
3) `scripts`. В папке хранятся различные полезные скрипты, такие как обработка 1 изображения, видео потока и др. Состав может меняться.
4) `tests`. В папке хранятся юнит-тесты модулей библиотеки 


## Использование библиотеки

### Готовые скрипты
Готовые скрипты хранятся в папке scripts. 

Перейти в папку можно набрав
`cd scripts`

#### `process_img.py` - Скрипт запускающий конвейер на 1 изображении в формате CLI. 

Параметры:
- `-i`, `--img_path` - путь до изображения
- `-d`, `--device` - какое устройство использовать для инференса. По умолчанию 'cpu'
- `-f`, `--format` - формат моделей для использования. Допускается 'ONNX', 'OpenVINO', 'CoreML'. По умолчанию 'ONNX'
- `--check_quality` - Нужно ли запускать сети качества, по умолчанию False
- `--img_size` - максимальный размер изображения по большей стороне, по умолчанию 1500

Результат работы выводится на экран в формате json

#### `process_video.py` - Скрипт запускающий конвейер на видео потоке с веб-камеры или видео потока.
- '-v', '--video_url' 
Возможны три варианта использования:
  - путь до видео файла video.mov - запускает обработку этого видео файла
  - ссылка на видео поток http://192.168.0.1:8080/video Рекомендуем использовать любое внешнее ПО для организации стриминга видео, например программу IP WEBCAM под Android или IOS
  - webcam (по умолчанию), работа с веб камерой по умолчанию на вашем компьютере
- '-z', '--screen_size'
В демонстрационном режиме допустимы только два варианта 720p или 1080p
по умолчанию 720p
- '-d', '--device'
Вы можете выбрать на каком устройстве обрабатывать видео gpu - видеокарта или cpu - процессор
по умолчанию gpu

Убедитесь что вы установили верно драйвера CUDA, CUDNN и драйвера видео карты для запуска на GPU
Инструкция по установке тут:
https://docs.nvidia.com/deeplearning/cudnn/install-guide/index.html

- Примеры запуска:

Windows 
1. Create and activate virtual env - создать и активировать виртуальное окружение. Для его создания ознакомьтесь 
с информацией по ссылке https://docs.python.org/3/library/venv.html
2. pip install -r requirements.txt
3. Можно пользоваться библиотекой 

Например перейдя в папку `scripts` набрать: `python process_video.py -v webcam -z 1080p -d gpu` для работы с видеопотоком
с определенными параметрами
или `python process_video.py` с параметрами по умолчанию для работы с видеопотоком  

Linux
1. Create and activate virtual env - создать и активировать виртуальное окружение. Для его создания ознакомьтесь 
с информацией по ссылке https://docs.python.org/3/library/venv.html
2. pip install -r requirements.txt
3. sudo apt update
4. sudo apt upgrade
5. sudo apt-get install ffmpeg libsm6 libxext6
6. Можно работать с библиотекой

Например перейдя в папку `scripts` набрать: `python process_video.py -v webcam -z 1080p -d gpu` для работы с видеопотоком
с определенными параметрами
или `python process_video.py` с параметрами по умолчанию для работы с видеопотоком  

### Использование основного конвейера библиотеки
#### Класс Pipeline. 
Основной класс реализующий конвейер обработки изображений. При создании объекта необязательными параметрами являются:
- `model_format` - 'ONNX', 'OpenVINO', 'CoreML' 
- `device` - 'cpu', 'gpu'

После создания объекта, в объект передаем изображение. Параметры передаваемые в объект класса Pipeline:
- `img_path` - Путь до изображение в форматах str, Path, либо изображение в формате np.ndarray. 
ВАЖНО! При передаче изображения, как np.ndarray, картинка никак не предобрабатывается кроме ресайза до `img_size` по большей стороне
- `get_doc_borders` - по умолчанию True. Определяет, нужно ли детектировать границы документа на изображении и 
восстанавливать геометрию
- `find_text_fields` - по умолчанию True. Определяет, нужно ли детектировать текстовые поля. Если принимает значение False, 
то работа конвейера после детекции изображения не производится (нет OCR).
- `ocr` - по умолчанию True. Определяет, нужно ли производить распознавание текста внутри найденных текстовых полей
- `check_quality` - по умолчанию True. Определяет, нужно ли запускать модули проверки качества изображения (BLur, Glate, PrintSpoofing, LCDSpoofing)
- `low_quality` - по умолчанию True. Определяет, нужно ли обрабатывать изображения с низким качеством (например, замечен Blue, Glare)
- `docconf` - по умолчанию 0.5. Определяет граничное значение выдаваемое, ниже которого документы отклоняются, как низкого качества. Допустимые значения (0..1)
- `img_size` - максимальный размер изображения по большей стороне, подаваемый на распознавание

Объект Pipeline после окончания работы возвращает объект PipelineResults 

#### PipelineResults
Объект содержит результаты работы конвейера на изображении и обладает рядом удобных свойств для получения информации в удобном виде. 

Основные из них:
- `@property def ocr(self) -> Union[Dict, None]:` - возвращает результат работы конвейера по распознаванию текста в документе в формате словарь
- `@property def doctype(self) -> Union[str, None]:` - возвращает тип документа
- `@property def quality(self) -> dict:` - возвращает всю информацию о качестве документа в формате словарь
- `@property def rotated_image(self) -> np.ndarray:` - возвращает развернутое изображение
- `@property def img_with_fixed_perspective(self) -> Union[list, None]:` - возвращает восстановленное изображение
- `@property def text_fields(self) -> Union[Tuple[list, list], None]:` - возваращает кортеж из координат и классов текстовых полей и лоскутов изображений
- `@property def words_patches(self) -> Union[Dict, None]:` - возвращает словарь в котором ключем является название поля, 
а значения лоскуты слов и их распознанный аналог (если проводился OCR)


#### Пример:
```python
from document_processing import Pipeline

pipeline = Pipeline(model_format='OpenVINO', device='cpu')
result = pipeline(img_path='img.jpg')
print(result.ocr)
```

### Использование отдельных модулей библиотеки
Возможно использование отдельных модулей библиотеки. 

#### Пример:
```python
from document_processing.pipeline_modules import Angle90

angle90 = Angle90(model_format='OpenVINO', device='cpu')
result = angle90.predict(img='img.jpg') # if we want to get only result from net
result_with_warped = angle90.predict_transform(img='img.jpg') # if we want also warp image
```

## Об авторах проекта

### Митянина Анастасия Владимировна 
- email: av.mityanina@zbrsk.ru

### Мельников Виталий Андреевич
- email: protei300@gmail.com

### Валуев Дмитрий Валерьевич
- email: dee-mon@mail.ru

### Карпич Александр Владимирович
- email: avkarpich@gmail.com

### Вохминцев Александр Владиславович
- email: vav@csu.ru

## Поддержка
Данный проект выполнен при финансировании Фонда Содействия Инновациям https://fasie.ru/. 



